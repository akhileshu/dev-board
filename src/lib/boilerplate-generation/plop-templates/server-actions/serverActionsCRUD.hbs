"use server";

import {   FetchResponse,
  MutateResponse,
  fetchError,
  fetchErrorNotLoggedIn,
  fetchSuccess,
  handleFetchAction,
  handleMutateAction,
  mutateError,
  mutateErrorNotLoggedIn,
  mutateSuccess,
  parseFormData,  } from "@/lib/server-actions/handleAction";
import { {{camelCase name}}CreateSchema, {{camelCase name}}UpdateSchema, {{camelCase name}}DeleteSchema } from "../schemas/{{camelCase name}}Schemas";

import { getServerUser } from "@/lib/auth/lib";
import { myPrisma } from "@/lib/db/prisma";
import { getMessage } from "@/lib/message/lib/get-message";


import {
  checkLimit,
  incrementLimit,
} from "../../../lib/limit-db-writes/limitHandler";

export async function get{{pascalCase name}}s(): Promise<FetchResponse<unknown>> {
  return handleFetchAction(async () => {
    const {{camelCase name}}s = await myPrisma.{{camelCase schemaName}}.findMany();
    return fetchSuccess({{camelCase name}}s);
  });
}

export async function get{{pascalCase name}}ById(id: string): Promise<FetchResponse<unknown>> {
  return handleFetchAction(async () => {
    const {{camelCase name}} = await myPrisma.{{camelCase schemaName}}.findUnique({
      where: { id },
    });
    return fetchSuccess({{camelCase name}});
  });
}

export async function create{{pascalCase name}}(_: unknown, formData: FormData): Promise<MutateResponse<undefined, typeof {{camelCase name}}CreateSchema>> {
  return handleMutateAction(async () => {
    const user = await getServerUser();
    if (!user) return mutateErrorNotLoggedIn;

    const { data, fieldErrors } = parseFormData(formData, {{camelCase name}}CreateSchema);
    if (fieldErrors) return mutateError(getMessage("{{camelCase name}}", "CREATE_ERROR"), fieldErrors);

    await myPrisma.{{camelCase schemaName}}.create({ data: { ...data, userId: user.id } });
    return mutateSuccess(getMessage("{{camelCase name}}", "CREATE_SUCCESS"));
  });
}

export async function update{{pascalCase name}}(_: unknown, formData: FormData): Promise<MutateResponse<undefined, typeof {{camelCase name}}UpdateSchema>>  {
  return handleMutateAction(async () => {
    const user = await getServerUser();
    if (!user) return mutateErrorNotLoggedIn;

    const { data, fieldErrors } = parseFormData(formData, {{camelCase name}}UpdateSchema);
    if (fieldErrors) return mutateError(getMessage("{{camelCase name}}", "UPDATE_ERROR"), fieldErrors);

    await myPrisma.{{camelCase schemaName}}.update({ where: { id: data.id, userId: user.id }, data });
    return mutateSuccess(getMessage("{{camelCase name}}", "UPDATE_SUCCESS"));
  });
}

export async function delete{{pascalCase name}}(_: unknown, formData: FormData): Promise<MutateResponse<undefined, typeof {{camelCase name}}DeleteSchema>> {
  return handleMutateAction(async () => {
    const user = await getServerUser();
    if (!user) return mutateErrorNotLoggedIn;

    const { data, fieldErrors } = parseFormData(formData, {{camelCase name}}DeleteSchema);
    if (fieldErrors) return mutateError(getMessage("{{camelCase name}}", "DELETE_ERROR"), fieldErrors);

    await myPrisma.{{camelCase schemaName}}.delete({ where: { id: data.id, userId: user.id } });
    return mutateSuccess(getMessage("{{camelCase name}}", "DELETE_SUCCESS"));
  });
}
